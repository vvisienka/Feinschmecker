# Redis Configuration - Caching Limits Focus
# Primary Goal: Limit caching to prevent memory exhaustion

# ============================================
# MEMORY MANAGEMENT & CACHING LIMITS (PRIMARY FOCUS)
# ============================================

# Hard limit to prevent Redis from consuming all system memory
maxmemory 2gb

# Aggressively evict least recently used keys when memory limit is reached (optimal for caching)
maxmemory-policy allkeys-lru

# Sample size for LRU eviction (balance between accuracy and performance)
maxmemory-samples 5

# Non-blocking eviction for better performance during cache cleanup
lazyfree-lazy-eviction yes

# Non-blocking expiration of keys with TTL
lazyfree-lazy-expire yes

# ============================================
# CACHE-SPECIFIC OPTIMIZATIONS
# ============================================

# Reduce background task frequency to save CPU (explicit for cache-heavy workloads)
# Lower hz value reduces CPU usage for background tasks like key expiration
hz 10

# RDB snapshots - less frequent since cache data is ephemeral
# Save if at least 1 key changed in 1 hour
save 3600 1
# Save if at least 100 keys changed in 5 minutes
save 300 100
# Save if at least 10000 keys changed in 1 minute
save 60 10000

# ============================================
# PERSISTENCE (Secondary - Cache Data is Ephemeral)
# ============================================

# Keep AOF enabled for Celery task durability
appendonly yes

# Balanced durability and performance
appendfsync everysec

# Better performance during AOF rewrite (acceptable for cache)
no-appendfsync-on-rewrite yes

# ============================================
# SECURITY
# ============================================

# Disable dangerous commands
rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command CONFIG ""

# Protected mode disabled for Docker network access
# Docker network provides isolation, so protected mode is not needed
protected-mode no

# Bind directive - commented out to allow Docker network access
# In Docker, we need Redis accessible from other containers on the same network
# The Docker network itself provides isolation, so binding to all interfaces is safe
# bind 127.0.0.1

# ============================================
# PERFORMANCE & MONITORING
# ============================================

# Handle more simultaneous connections
tcp-backlog 2048

# Log commands taking more than 10ms
slowlog-log-slower-than 10000

# Keep last 128 slow commands
slowlog-max-len 128

# Close idle client connections after 5 minutes
timeout 300

# ============================================
# NETWORK
# ============================================

# Port
port 6379

# ============================================
# GENERAL
# ============================================

# Daemonize (not needed in Docker, but set for clarity)
daemonize no

# Log level
loglevel notice

